include ../buildconf.mk

MS_FILES	:=

# include MS configuration makefile
include configure_ms.mk
MS_CONFIG_FILES := $(BUILD_MS)/app.yaml

# yaml appengine config files
MS_YAML	:= $(wildcard *.yaml)

# include base files 
MS_FILES	:= $(MS_FILES) $(wildcard *.py)
MS_FILES	:= $(MS_FILES) $(wildcard common/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard protobufs/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard storage/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard storage/backends/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard MS/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard MS/methods/*.py)

# google protobuf files 
MS_FILES	:= $(MS_FILES) $(wildcard google/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard google/protobuf/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard google/protobuf/internal/*.py)
MS_FILES	:= $(MS_FILES) $(wildcard google/protobuf/compiler/*.py)

# protobuf-generated files 
MS_PROTOBUF_FILES	:= $(notdir $(wildcard $(BUILD_PROTOBUFS_PYTHON)/*.py))

# python protobuf targets
MS_FILES_BUILD_PROTOBUF	:= $(patsubst %.py,$(BUILD_MS)/protobufs/%.py,$(MS_PROTOBUF_FILES))

# python targets
MS_FILES_BUILD	:= $(patsubst %.py,$(BUILD_MS)/%.py,$(MS_FILES))

# all targets
MS_BUILD_ALL := $(MS_FILES_BUILD) $(MS_FILES_BUILD_PROTOBUF) $(MS_CONFIG_FILES) $(MS_YAML)

all: $(MS_BUILD_ALL)

$(BUILD_MS)/%.py: %.py
	mkdir -p "$(@D)"
	cp -a "$<" "$@"

# fix up protobufs to work on GAE 
$(BUILD_MS)/protobufs/%.py: $(BUILD_PROTOBUFS_PYTHON)/%.py google_protobuf_fixer.pyin
	mkdir -p"$(@D)"
	echo '# Automatically generated by Makefile.  DO NOT EDIT!' > "$@"
	cat google_protobuf_fixer.pyin >> "$@"
	cat "$<" >> "$@"

# don't install items that embed build-time variables
MS_INSTALL_ITEMS	:= $(filter-out $(MS_CONFIG_FILES), $(MS_BUILD_ALL))
MS_INSTALL_TARGET	:= $(patsubst $(BUILD_MS)/%,$(INSTALL_MS)/%,$(MS_INSTALL_ITEMS))

.PHONY: install
install:	$(MS_INSTALL_TARGET)

$(INSTALL_MS)/%: $(BUILD_MS)/%
	mkdir -p "$(@D)"
	cp -a "$<" "$@"

.PHONY: clean
clean:
	rm -rf $(BUILD_MS)

# debugging
print-%: ; @echo $*=$($*)

